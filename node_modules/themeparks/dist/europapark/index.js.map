{"version":3,"sources":["../../lib/europapark/index.js"],"names":["Park","require","Moment","crypto","s_apiBase","Symbol","s_apiVersion","s_parkSecretToken","EuropaPark","options","name","latitude","longitude","useragent","timezone","api_base","api_version","secret_token","currentParkDate","utc","format","Log","hmac","createHmac","update","code","digest","toUpperCase","Cache","Wrap","Promise","resolve","reject","HTTP","url","then","ride_data","rideNames","enName","deName","i","poi","find","langArr","language","undefined","value","bind","FetchRideData","data","GenerateAccessToken","waitTimes","length","rideIdx","ride","Rides","WaitTime","ridetime","rideObject","GetRideObject","id","waittime","time","active","status","openingTimes","season","j","sched","seasonTimes","Schedule","SetRange","startDate","tz","from","Timezone","endDate","until","openingTime","opening","closingTime","closing","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["\"use strict\";\n\n// include core Park class\nvar Park = require(\"../park\");\nvar Moment = require(\"moment-timezone\");\n\n// crypto library for generating access tokens\nvar crypto = require(\"crypto\");\n\nvar s_apiBase = Symbol();\nvar s_apiVersion = Symbol();\nvar s_parkSecretToken = Symbol();\n\n/**\n * Implements the Europa Park API framework.\n * @class\n * @extends Park\n */\nclass EuropaPark extends Park {\n    /**\n     * Create new EuropaPark Object.\n     * @param {Object} [options]\n     * @param {String} [options.api_base] Optional base URL for API requests\n     * @param {String} [options.api_version] API Version to make requests to (default: 'api-5.9')\n     * @param {String} [options.secret_token] Secret token to use to generate the wait times API access token\n     */\n    constructor(options = {}) {\n        options.name = options.name || \"Europa Park\";\n\n        // Europa-Park coordinates\n        options.latitude = options.latitude || 48.268931;\n        options.longitude = options.longitude || 7.721559;\n\n        // Use the Android app's user-agent\n        options.useragent = options.useragent || \"okhttp/3.9.1\";\n\n        // park's timezone\n        options.timezone = \"Europe/Berlin\";\n\n        // inherit from base class\n        super(options);\n\n        // accept overriding the API base URL\n        this[s_apiBase] = options.api_base || \"https://api.europapark.de/\";\n        // accept overriding API version\n        this[s_apiVersion] = options.api_version || \"api-5.9\";\n        // take secret token from options, or default to known token\n        this[s_parkSecretToken] = options.secret_token || \"ZhQCqoZp\";\n    }\n\n    /**\n     * Generate an access token for accessing wait times\n     * @returns {String} Current Access Token\n     */\n    GenerateAccessToken() {\n        // generate wait times access code\n\n        // start with current park date in UTC (YYYYMMDDHH format)\n        var currentParkDate = Moment.utc().format(\"YYYYMMDDHH\");\n        this.Log(\"Calculated token date as\", currentParkDate);\n\n        // sha256 hash using key\n        var hmac = crypto.createHmac(\"sha256\", this[s_parkSecretToken]);\n        hmac.update(currentParkDate);\n        var code = hmac.digest(\"hex\").toUpperCase();\n\n        this.Log(\"Generated Europa wait times code\", code);\n\n        return code;\n    }\n\n    /**\n     * Fetches fresh or cached ride data from the park API\n     * @returns {Promise<Object>} Object of Ride ID => Ride Name in English (or German if no English name is available)\n     */\n    FetchRideData() {\n        return this.Cache.Wrap(\"ridedata\", function () {\n            return new Promise(function (resolve, reject) {\n                // grab ride names from the API\n                this.HTTP({\n                    url: this[s_apiBase] + this[s_apiVersion] + \"/pointsofinterest\",\n                }).then(function (ride_data) {\n                    // extract names from returned data\n                    var rideNames = {};\n                    var enName, deName;\n\n                    for (var i = 0, poi; poi = ride_data[i++];) {\n                        // types:\n                        //  1: ride\n                        //  2: food\n                        //  3: park entrance\n                        //  5: shop\n                        //  6: show\n\n                        // not all attractions have English names, so fallback to German if missing\n                        enName = poi.name.find(function (langArr) {\n                            return langArr.language === \"en\";\n                        });\n                        deName = poi.name.find(function (langArr) {\n                            return langArr.language === \"de\";\n                        });\n\n                        rideNames[poi.code] =\n                            (typeof enName !== undefined ? enName.value : false) ||\n                            (typeof deName !== undefined ? deName.value : \"???\");\n                    }\n\n                    resolve(rideNames);\n                }.bind(this), reject);\n            }.bind(this));\n        }.bind(this), 60 * 60 * 24);\n    }\n\n    /**\n     * Fetch Wait times\n     */\n    FetchWaitTimes() {\n        return new Promise(function (resolve, reject) {\n            // fetch ride names before getting wait times (usually this will come from the cache)\n            this.FetchRideData().then(function (rideNames) {\n                this.HTTP({\n                    url: `${this[s_apiBase]}${this[s_apiVersion]}/waitingtimes`,\n                    data: {\n                        \"mock\": false,\n                        \"token\": this.GenerateAccessToken()\n                    }\n                }).then(function (waitTimes) {\n                    // if empty, park is just totally closed (!)\n                    if (!waitTimes.length) {\n                        // mark each ride as inactive\n                        // loop through previously known-about rides\n                        for (var rideIdx, ride; ride = this.Rides[rideIdx++];) {\n                            // set ride time to -1 to mark as closed\n                            ride.WaitTime = -1;\n                        }\n\n                        // TODO - loop over a hard-coded list of known rides at the park\n\n                        // resolve early\n                        return resolve();\n                    }\n\n                    for (var i = 0, ridetime; ridetime = waitTimes[i++];) {\n                        // FYI, ridetime.type:\n                        //   1: rollercoaster\n                        //   2: water\n                        //   3: adventure\n\n                        // status meanings:\n                        //  0: Open!\n                        //  1: Wait time is over 90 minutes\n                        //  2: Closed\n                        //  3: Broken Down\n                        //  4: Bad weather\n                        //  5: VIP/Special Tour\n                        //  other: Probably just crazy long wait times\n\n                        // get this ride's' object\n                        var rideObject = this.GetRideObject({\n                            id: ridetime.code,\n                            name: rideNames[ridetime.code] || \"???\",\n                        });\n\n                        // lowest wait time is 1 minute (according to app)\n                        var waittime = ridetime.time > 0 ? ridetime.time : 0;\n                        var active = (ridetime.status === 0 || ridetime.status === 1);\n                        // copy how the app reacts to >90 minute waits\n                        if (ridetime.status === 1) waittime = 91;\n\n                        // set new wait time\n                        rideObject.WaitTime = active ? waittime : -1;\n                    }\n\n                    resolve();\n                }.bind(this), reject);\n            }.bind(this), reject);\n        }.bind(this));\n    }\n\n    /**\n     * Fetch Europa Park opening time data\n     * @returns {Promise}\n     */\n    FetchOpeningTimes() {\n        return new Promise(function (resolve, reject) {\n            this.HTTP({\n                url: `${this[s_apiBase]}${this[s_apiVersion]}/openingtimes`\n            }).then(function (openingTimes) {\n                for (let i = 0, season; season = openingTimes[i++];) {\n                    for (let j = 0, sched; sched = season.seasonTimes[j++];) {\n                        // EuropaPark returns opening hours in blocks of ranges\n                        //  set each range of dates in our schedule object\n                        this.Schedule.SetRange({\n                            startDate: Moment.tz(sched.from, \"YYYY-MM-DD\", this.Timezone),\n                            endDate: Moment.tz(sched.until, \"YYYY-MM-DD\", this.Timezone),\n                            openingTime: Moment(sched.opening, \"HH:mm\"),\n                            closingTime: Moment(sched.closing, \"HH:mm\")\n                        });\n                    }\n                }\n\n                // TODO - the park is actually closed on various days and has announced varients to these times\n                //  find out how to get these properly!\n\n                resolve();\n            }.bind(this), reject);\n        }.bind(this));\n    }\n}\n\n// export the class\nmodule.exports = EuropaPark;"]}